<!DOCTYPE html>
<html>
    <head>
        <title>Super8</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <style>
            canvas{
                width: 100%;
                height: 100%;
            }
            
            body{
                margin: 0px;
                overflow: hidden;
            }
            
            
            #blockscreen{
                position: absolute;
                width: 100%;
                height: 100%;
                background-color: transparent;
            }
            
            #anleitung{   
                position: absolute;
                margin-top: 10%;
                margin-left: 10%;
                background-color: transparent;
                font-size: 40px;
                font-family: Helvetica;
                font-weight: 100;
                color: white;
                cursor: pointer;
            }
            
        </style>
        
    </head>
    <body>
        
        <script src="three.min.js"></script>
        <script src="PointerLockControls.js"></script>
        
        <!-- Orbit Controls: -->
        <script src="controls.js"></script>
        
        <div id="blockscreen">
            <div id="anleitung">
                <center>
                    <img src="logo/paranormal.png" alt="Paranormal"><br><br>
                <p> HEY VOLL TOLL ICH HAB DIE STEUERUNG HINBEKOMMEN! </p>
                Start per Klick, <br>WASD/Arrow-Keys für die Steuerung, ESC: "Pause"
                <br> Maus: Drehen/ Look Around.
                <p> Küsschen. PS: bisher nur Firefox kompatibel <br>
                    PS: OrbitControls funktionieren nicht mehr</p>
                </center>
            </div>
        </div>
        
        <script>
            
            
            
            //SCENE
            var scene = new THREE.Scene();
            scene.fog = new THREE.Fog("grey", 0, 30);
            
            
            
            //CAMERA
            var camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            //camera.position.y = 1;
            
            
            
            //RENDERER
            var renderer = new THREE.WebGLRenderer({antialias: false});
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMapEnabled = true;
            renderer.shadowMapSoft = true;
            renderer.shadowMapType = THREE.PCFSoftShadowMap;
            document.body.appendChild(renderer.domElement);
            
            //NEW CONTROLS
			var controlsEnabled = false;

            var moveForward = false;
            var moveBackward = false;
            var moveLeft = false;
            var moveRight = false;
			
            // Orbit CONTROLS
            controls = new THREE.OrbitControls(camera);
			
			var keys = new Array( 128 );
			var key_W = false;
			var key_A = false;
			var key_S = false;
			var key_D = false;
			
			for (var i = 0; i < keys.length; i++) {
				keys[i] = false;
			}
			
			window.addEventListener('keydown', keyPressed, false);
			window.addEventListener('keyup', keyReleased, false);
			
			var move = 0.1;
			
			//COLLISION-RAYS
				var colObj = [];
			
				//VECTORS
				var vecU = new THREE.Vector3(0, 0.3, 0);
				var vecD = new THREE.Vector3(0, -0.3, 0);
				var vecFU = new THREE.Vector3(0, 0.3, -0.3);
				var vecFD = new THREE.Vector3(0, -0.3, -0.3);
				var vecBU = new THREE.Vector3(0, 0.3, 0.3);
				var vecBD = new THREE.Vector3(0, -0.3, 0.3);
				var vecLU = new THREE.Vector3(-0.3, 0.3, 0);
				var vecLD = new THREE.Vector3(-0.3, -0.3, 0);
				var vecRU = new THREE.Vector3(0.3, 0.3, 0);
				var vecRD = new THREE.Vector3(0.3, -0.3, 0);
				
				var dirFront = new THREE.Vector3(0, 0, -1);
				var dirBack = new THREE.Vector3(0, 0, 1);
				var dirLeft = new THREE.Vector3(-1, 0, 0);
				var dirRight = new THREE.Vector3(1, 0, 0);
				var dirUp = new THREE.Vector3(0, 1, 0);
				var dirDown = new THREE.Vector3(0, -1, 0);
				
				//FRONT
				var rayFMU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecU), dirFront, 0.15, 0.45);
				var rayFLU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecLU), dirFront, 0.15, 0.45);
				var rayFRU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecRU), dirFront, 0.15, 0.45);
				
				var rayFMD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecD), dirFront, 0.15, 0.45);
				var rayFLD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecLD), dirFront, 0.15, 0.45);
				var rayFRD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecRD), dirFront, 0.15, 0.45);
				
				//BACK
				var rayBMU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecU), dirBack, 0.15, 0.45);
				var rayBLU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecLU), dirBack, 0.15, 0.45);
				var rayBRU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecRU), dirBack, 0.15, 0.45);
				
				var rayBMD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecD), dirBack, 0.15, 0.45);
				var rayBLD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecLD), dirBack, 0.15, 0.45);
				var rayBRD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecRD), dirBack, 0.15, 0.45);
				
				//LEFT
				var rayLMU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecU), dirLeft, 0.15, 0.45);
				var rayLFU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecFU), dirLeft, 0.15, 0.45);
				var rayLBU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecBU), dirLeft, 0.15, 0.45);
				
				var rayLMD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecD), dirLeft, 0.15, 0.45);
				var rayLFD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecFD), dirLeft, 0.15, 0.45);
				var rayLBD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecBD), dirLeft, 0.15, 0.45);
				
				//RIGHT
				var rayRMU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecU), dirRight, 0.15, 0.45);
				var rayRFU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecFU), dirRight, 0.15, 0.45);
				var rayRBU = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecBU), dirRight, 0.15, 0.45);
				
				var rayRMD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecD), dirRight, 0.15, 0.45);
				var rayRFD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecFD), dirRight, 0.15, 0.45);
				var rayRBD = new THREE.Raycaster(new THREE.Vector3().addVectors(camera.position, vecBD), dirRight, 0.15, 0.45);
            
            
            //LIGHTS
                //DIRECTIONAL LIGHT
                var directionalLight = new THREE.DirectionalLight("white", 0.1);
                directionalLight.position.set(40, 40, 40);
                directionalLight.target.position.set(0, 0, 10);
                directionalLight.castShadow = true;
                directionalLight.shadowDarkness = 0.3;

                directionalLight.shadowCameraNear = 0;
                directionalLight.shadowCameraFar = 100;

                directionalLight.shadowCameraLeft = -35;
                directionalLight.shadowCameraRight = 35;
                directionalLight.shadowCameraTop = 35;
                directionalLight.shadowCameraBottom = -35;
                
                directionalLight.shadowMapWidth = 2048;
                directionalLight.shadowMapHeight = 2048;
                scene.add(directionalLight);
                
                //AMBIENTLIGHT
                var ambientLight = new THREE.AmbientLight(0x404040);
                scene.add(ambientLight);
                
                //SPOT LIGHT
                var spotLight = new THREE.SpotLight("blue", 1);
                spotLight.target.position.set(0, 0.5, 0.5);
                spotLight.position.set(4.5, 0.8, 3.5);
                spotLight.shadowCameraVisible = true;
                spotLight.castShadow = true;
                spotLight.shadowDarkness = 0.5;
                spotLight.shadowCameraFov = 25;               
                spotLight.shadowCameraNear = 0.1;
                spotLight.shadowCameraFar = 8;
                scene.add(spotLight);


            //GEOMETRY
                //SKYBOX
                var imagePrefix = "textures/skybox/";
                var directions  = ["xpos", "xneg", "ypos", "yneg", "zpos", "zneg"];
                var imageSuffix = ".jpg";

                var skybox_array = [];
                for (var i = 0; i < 6; i++){
                    skybox_array.push(new THREE.MeshBasicMaterial({
                        map: THREE.ImageUtils.loadTexture(imagePrefix + directions[i] + imageSuffix),
                        side: THREE.BackSide
                    }));
                }
                var skybox = new THREE.Mesh(new THREE.BoxGeometry(100, 50, 100), new THREE.MeshFaceMaterial(skybox_array));
                skybox.position.y = 24;
                scene.add(skybox);                
            
                //HOUSE          
                var house_material = new THREE.MeshPhongMaterial({
                                        map: THREE.ImageUtils.loadTexture("textures/house/wood.jpg"),
                                        bumpMap: THREE.ImageUtils.loadTexture("textures/house/wood_DISP.jpg"),
                                        bumpScale: 0.1,
                                        side: THREE.DoubleSide
                                        });

                var house = new THREE.Mesh(new THREE.BoxGeometry(10, 2.5, 8), house_material);
                house.position.y = 1.25;
                house.castShadow = true;
                house.receiveShadow = true;
                scene.add(house);
				colObj.push(house);
                    
                    //FLOOR
                    var floor = new THREE.Mesh(new THREE.PlaneBufferGeometry(10, 8), house_material);
                    floor.rotateX(-Math.PI/2);
                    floor.position.y = 0.05;
                    floor.receiveShadow = true;
                    scene.add(floor);
                
                    //ROOF SIDES
                    var roof_side_geometry = new THREE.Geometry();
                    roof_side_geometry.vertices.push(new THREE.Vector3(-5, 4, 0));
                    roof_side_geometry.vertices.push(new THREE.Vector3(-5, 2.5, -4));
                    roof_side_geometry.vertices.push(new THREE.Vector3(-5, 2.5, 4));

                    var uvs = [];
                    uvs.push(new THREE.Vector2(0.5, 1));
                    uvs.push(new THREE.Vector2(0, 0));
                    uvs.push(new THREE.Vector2(1, 0));

                    roof_side_geometry.faces.push(new THREE.Face3(0,1,2));
                    roof_side_geometry.computeFaceNormals();
                    roof_side_geometry.faceVertexUvs[0].push([uvs[0], uvs[1], uvs[2]]);
                    var roof_side_material = new THREE.MeshPhongMaterial({map: THREE.ImageUtils.loadTexture("textures/house/wood.jpg"), bumpMap: THREE.ImageUtils.loadTexture("textures/house/wood_DISP.jpg"), bumpScale: 0.1, side: THREE.DoubleSide});
                    var side_left = new THREE.Mesh(roof_side_geometry, roof_side_material);
                    side_left.castShadow = true;
                    side_left.receiveShadow = true;
                    scene.add(side_left);

                    var side_right = side_left.clone();
                    side_right.position.x = 10;
                    side_right.castShadow = true;
                    side_right.receiveShadow = true;
                    scene.add(side_right);

                    //ROOFTOP
                    var roof_top_geometry = new THREE.PlaneGeometry(11, 4.5);
                    var roof_top_material = new THREE.MeshPhongMaterial({map: THREE.ImageUtils.loadTexture("textures/house/roof.jpg"), bumpMap: THREE.ImageUtils.loadTexture("textures/house/roof_DISP.jpg"), bumpScale: 0.1, specularMap: THREE.ImageUtils.loadTexture("textures/house/roof_SPEC.jpg"), specular: new THREE.Color("grey"), side: THREE.DoubleSide});
                    var roof_top_front = new THREE.Mesh(roof_top_geometry, roof_top_material);
                    roof_top_front.rotateX(-1.21);
                    roof_top_front.position.set(0, 3.26, 2.1);
                    roof_top_front.castShadow = true;
                    roof_top_front.receiveShadow = true;
                    scene.add(roof_top_front);

                    var roof_top_back = new THREE.Mesh(roof_top_geometry, roof_top_material);
                    roof_top_back.rotateY(-Math.PI);
                    roof_top_back.rotateX(-1.21);
                    roof_top_back.position.set(0, 3.26, -2.1);
                    roof_top_back.castShadow = true;
                    roof_top_back.receiveShadow = true;
                    scene.add(roof_top_back);
                    
                    //MIRROR
                    var mirror_camera = new THREE.CubeCamera(0.1, 15, 128);  //128 zu 1024 ändern
                    mirror_camera.position.set(-3, 1, -3.9);
                    scene.add(mirror_camera);
                    
                    var mirror = new THREE.Mesh(new THREE.PlaneBufferGeometry(1, 1), new THREE.MeshPhongMaterial({envMap: mirror_camera.renderTarget}));
                    mirror.position.set(0, 1.5, -3.99);
                    scene.add(mirror);


                //GROUND
                    //GRASS
                    var grass_geometry = new THREE.PlaneGeometry(5, 5);
                    var grass_material = new THREE.MeshPhongMaterial({map: THREE.ImageUtils.loadTexture("textures/ground/grass.jpg"), bumpMap: THREE.ImageUtils.loadTexture("textures/ground/grass_DISP.jpg"), bumpScale: 0.1});                                                        
                    var grass_array = [];
                    var x = -25;
                    var z = -25;
                    for(var i = 0; i < 154; i++){
                        grass_array.push(new THREE.Mesh(grass_geometry, grass_material));
                        grass_array[i].position.set(x, 0, z);
                        grass_array[i].rotateX(-Math.PI/2);
                        grass_array[i].receiveShadow = true;
                        scene.add(grass_array[i]);
                        x += 5;
                        if(x > 25){
                            x = -25;
                            z += 5;
                        }
                    }
                    
                    //TREES                  
                    var loader = new THREE.JSONLoader();
                    loader.load("models/tree.json", function(geometry){
                        var material = new THREE.MeshPhongMaterial({map: THREE.ImageUtils.loadTexture("textures/ground/bark.jpg"), bumpMap: THREE.ImageUtils.loadTexture("textures/ground/bark_DISP.jpg"), bumpScale: 0.1});
                        
                        var thg = new THREE.BoxGeometry(0.3, 4, 0.3);
                        var thm = new THREE.MeshBasicMaterial({color: "black"});
                        
                        var tree0 = new THREE.Mesh(geometry, material);
                        var th0 = new THREE.Mesh(thg, thm);
                        tree0.position.set(8, 0, 2);
                        th0.position.set(8, 2, 2);
                        tree0.castShadow = true;
                        th0.visible = false;
                        
                        var tree1 = new THREE.Mesh(geometry, material);
                        var th1 = new THREE.Mesh(thg, thm);
                        tree1.position.set(5, 0, 10);
                        th1.position.set(5, 2, 10);
                        tree1.castShadow = true;
                        th1.visible = false;
                        
                        var tree2 = new THREE.Mesh(geometry, material);
                        var th2 = new THREE.Mesh(thg, thm);
                        tree2.position.set(-10, 0, 20);
                        th2.position.set(-10, 2, 20);
                        tree2.castShadow = true;
                        th2.visible = false;
                        
                        var tree3 = new THREE.Mesh(geometry, material);
                        var th3 = new THREE.Mesh(thg, thm);
                        tree3.position.set(-15, 0, -15);
                        th3.position.set(-15, 2, -15);
                        tree3.castShadow = true;
                        th3.visible = false;
                        
                        var tree4 = new THREE.Mesh(geometry, material);
                        var th4 = new THREE.Mesh(thg, thm);
                        tree4.position.set(25, 0, -23);
                        th4.position.set(25, 2, -23);
                        tree4.castShadow = true;
                        th4.visible = false;
                        
                        var tree5 = new THREE.Mesh(geometry, material);
                        var th5 = new THREE.Mesh(thg, thm);
                        tree5.position.set(-20, 0, 3);
                        th5.position.set(-20, 2, 3);
                        tree5.castShadow = true;
                        th5.visible = false;
                        
                        var tree6 = new THREE.Mesh(geometry, material);
                        var th6 = new THREE.Mesh(thg, thm);
                        tree6.position.set(22, 0, 35);
                        th6.position.set(22, 2, 35);
                        tree6.castShadow = true;
                        th6.visible = false;
                        
                        var tree7 = new THREE.Mesh(geometry, material);
                        var th7 = new THREE.Mesh(thg, thm);
                        tree7.position.set(18, 0, 8);
                        th7.position.set(18, 2, 8);
                        tree7.castShadow = true;
                        th7.visible = false;
                        
                        var tree8 = new THREE.Mesh(geometry, material);
                        var th8 = new THREE.Mesh(thg, thm);
                        tree8.position.set(-18, 0, 30);
                        th8.position.set(-18, 2, 30);
                        tree8.castShadow = true;
                        th8.visible = false;
                        
                        var tree9 = new THREE.Mesh(geometry, material);
                        var th9 = new THREE.Mesh(thg, thm);
                        tree9.position.set(0, 0, -15);
                        th9.position.set(0, 2, -15);
                        tree9.castShadow = true;
                        th9.visible = false;
                        
                        scene.add(tree0, tree1, tree2, tree3, tree4, tree5, tree6, tree7, tree8, tree9);
                        scene.add(th0, th1, th2, th3, th4, th5, th6, th7, th8, th9);
                    });    
						//scene.add(th0, th1, th2, th3, th4, th5, th6, th7, th8, th9);
						//colObj.push(th0);
						//colObj.push(th1);
						//colObj.push(th2);
						//colObj.push(th3);
						//colObj.push(th4);
						//colObj.push(th5);
						//colObj.push(th6);
						//colObj.push(th7);
						//colObj.push(th8);
						//colObj.push(th9);
						//alert(colObj[1].position.x);
                    
                    
                //PARTICLE SYSTEM
                var particle_count = 500;
                var particles = new THREE.Geometry();
                particle_material = new THREE.PointCloudMaterial({color: "rgb(178,223,238)", size: 0.005});
                
                for(var p = 0; p < particle_count; p++){
                    var x = Math.random() * 60 - 30;
                    var y = Math.random() * 10 + 8;
                    var z = Math.random() * 70 - 30;
                    particles.vertices.push(new THREE.Vector3(x, y, z));
                }
                
                var particle_system = new THREE.PointCloud(particles, particle_material);
                scene.add(particle_system);  
                    
            
            //FUNCTION
            function updateParticleSystem(){
                for(var i = 0; i < particles.vertices.length; i++){
                    particles.verticesNeedUpdate = true;
                    if(particles.vertices[i].y < 0){
                        particles.vertices[i].y = Math.random() * 10 + 8;
                    }
                    particles.vertices[i].y -= 1;
                }              
            }
            
            function render(){                
                //MIRROR CUBECAMERA UPDATE
                mirror.visible = false;
                mirror_camera.updateCubeMap(renderer, scene);
                mirror.visible = true;
				
                //PARTICLE SYSTEM
                //updateParticleSystem();
                                
                //RENDERER
                renderer.render(scene,camera);	

				update();
				
                requestAnimationFrame(render);
                
                //UPDATE POSITIONS
                spotLight.target.updateMatrixWorld();
                
            }
            
			//UPDATE
			function update() {
				keyUpdate();
				rayUpdate();
                                updateParticleSystem();
				//movement();
			}
			
			function keyUpdate () {
				key_W = keys[87];
				key_A = keys[65];
				key_S = keys[83];
				key_D = keys[68];
			}
			
			function rayUpdate() {
				//VECTORS
				var yAxis = new THREE.Vector3(0, 1, 0);
				vecU.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecD.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecFU.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecFD.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecBU.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecBD.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecLU.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecLD.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecRU.applyAxisAngle(yAxis, yawObject.rotation.y);
				vecRD.applyAxisAngle(yAxis, yawObject.rotation.y);
				
				dirFront.applyAxisAngle(yAxis, yawObject.rotation.y);
				dirBack.applyAxisAngle(yAxis, yawObject.rotation.y);
				dirLeft.applyAxisAngle(yAxis, yawObject.rotation.y);
				dirRight.applyAxisAngle(yAxis, yawObject.rotation.y);
				dirUp.applyAxisAngle(yAxis, yawObject.rotation.y);
				dirDown.applyAxisAngle(yAxis, yawObject.rotation.y);
			
				//FRONT
				rayFMU.set(new THREE.Vector3().addVectors(yawObject.position, vecU), dirFront);
				rayFLU.set(new THREE.Vector3().addVectors(yawObject.position, vecLU), dirFront);
				rayFRU.set(new THREE.Vector3().addVectors(yawObject.position, vecRU), dirFront);
				
				rayFMD.set(new THREE.Vector3().addVectors(yawObject.position, vecD), dirFront);
				rayFLD.set(new THREE.Vector3().addVectors(yawObject.position, vecLD), dirFront);
				rayFRD.set(new THREE.Vector3().addVectors(yawObject.position, vecRD), dirFront);
				
				//BACK
				rayBMU.set(new THREE.Vector3().addVectors(yawObject.position, vecU), dirBack);
				rayBLU.set(new THREE.Vector3().addVectors(yawObject.position, vecLU), dirBack);
				rayBRU.set(new THREE.Vector3().addVectors(yawObject.position, vecRU), dirBack);
				
				rayBMD.set(new THREE.Vector3().addVectors(yawObject.position, vecD), dirBack);
				rayBLD.set(new THREE.Vector3().addVectors(yawObject.position, vecLD), dirBack);
				rayBRD.set(new THREE.Vector3().addVectors(yawObject.position, vecRD), dirBack);
				
				//LEFT
				rayLMU.set(new THREE.Vector3().addVectors(yawObject.position, vecU), dirLeft);
				rayLFU.set(new THREE.Vector3().addVectors(yawObject.position, vecFU), dirLeft);
				rayLBU.set(new THREE.Vector3().addVectors(yawObject.position, vecBU), dirLeft);
				
				rayLMD.set(new THREE.Vector3().addVectors(yawObject.position, vecD), dirLeft);
				rayLFD.set(new THREE.Vector3().addVectors(yawObject.position, vecFD), dirLeft);
				rayLBD.set(new THREE.Vector3().addVectors(yawObject.position, vecBD), dirLeft);
				
				//RIGHT
				rayRMU.set(new THREE.Vector3().addVectors(yawObject.position, vecU), dirRight);
				rayRFU.set(new THREE.Vector3().addVectors(yawObject.position, vecFU), dirRight);
				rayRBU.set(new THREE.Vector3().addVectors(yawObject.position, vecBU), dirRight);
				
				rayRMD.set(new THREE.Vector3().addVectors(yawObject.position, vecD), dirRight);
				rayRFD.set(new THREE.Vector3().addVectors(yawObject.position, vecFD), dirRight);
				rayRBD.set(new THREE.Vector3().addVectors(yawObject.position, vecBD), dirRight);
			}
			
			//COLLSION
			function checkCollision(ray1, ray2, ray3, ray4, ray5, ray6) {
				rayUpdate();
				
				var collide1 = ray1.intersectObjects(scene.children);
				var collide2 = ray2.intersectObjects(scene.children);
				var collide3 = ray3.intersectObjects(scene.children);
				var collide4 = ray4.intersectObjects(scene.children);
				var collide5 = ray5.intersectObjects(scene.children);
				var collide6 = ray6.intersectObjects(scene.children);
				
				if ( collide1.length > 0 || collide2.length > 0 || collide3.length > 0 || collide4.length > 0 || collide5.length > 0 || collide6.length > 0) {
					return true;
				}
				else {
					return false;
				}
			}

             // CONTROLS – Sterling
			function keyPressed(event){
				keys[event.keyCode] = true;
			}
			
			function keyReleased(event){
				keys[event.keyCode] = false;
			}
			
			function movement() {
				
			
				if (key_W) {
					if (checkCollision(rayFMU, rayFLU, rayFRU, rayFMD, rayFLD, rayFRD)) {
						move = 0;
					}
					else {
						move = 0.1;
					}
					camera.position.z -= move;
				}
				if (key_A) {
					if (checkCollision(rayLMU, rayLFU, rayLBU, rayLMD, rayLFD, rayLBD)) {
						move = 0;
					}
					else {
						move = 0.1;
					}
					camera.position.x -= move;
				}
				if (key_S) {
					if (checkCollision(rayBMU, rayBLU, rayBRU, rayBMD, rayBLD, rayBRD)) {
						move = 0;
					}
					else {
						move = 0.1;
					}
					camera.position.z += move;
				}
				if (key_D) {
					if (checkCollision(rayRMU, rayRFU, rayRBU, rayRMD, rayRFD, rayRBD)) {
						move = 0;
					}
					else {
						move = 0.1;
					}
					camera.position.x += move;
				}
			}   
              
            // CONTROLS - PointerLockControls 
            // http://www.html5rocks.com/en/tutorials/pointerlock/intro/
            var blockscreen = document.getElementById('blockscreen');
            var anleitung = document.getElementById('anleitung');
            
            var controls = new THREE.PointerLockControls(camera);
            scene.add(controls.getObject());
            
            var havePointerLock = 'pointerLockElement' in document || 
                    'mozPointerLockElement' in document || 
                    'webkitPointerLockElement' in document;

            if(havePointerLock){
                var element = document.body;
                var pointerlockchange = function(event){
                    if (document.pointerLockElement === element || 
                            document.mozPointerLockElement === element || 
                            document.webkitPointerLockElement === element){
                        
                        controlsEnabled = true;
			controls.enabled = true;
                        blockscreen.style.display = 'none';
                        
                    } else {
                        controls.enabled = false;
			blockscreen.style.display = '';
			anleitung.style.display = '';
                    }
                };
                
                
                var pointerlockerror = function (event){
                    anleitung.style.display = '';
                };

		// Hook pointer lock state change events
                document.addEventListener('pointerlockchange', pointerlockchange, false);
                document.addEventListener('mozpointerlockchange', pointerlockchange, false);
                document.addEventListener('webkitpointerlockchange', pointerlockchange, false);

                document.addEventListener('pointerlockerror', pointerlockerror, false);
                document.addEventListener('mozpointerlockerror', pointerlockerror, false);
                document.addEventListener('webkitpointerlockerror', pointerlockerror, false);

                anleitung.addEventListener('click', function(event){
                    anleitung.style.display = 'none';
                    
                    // Ask the browser to lock the pointer
                    element.requestPointerLock = element.requestPointerLock || 
                            element.mozRequestPointerLock || 
                            element.webkitRequestPointerLock;
                    element.requestPointerLock();
			
                    // Firefox oder Chrome (folgt noch)   
                    if (/Firefox/i.test(navigator.userAgent) || /OPR\/(\d+\.\d+)/i.test(navigator.userAgent)){
                        document.exitPointerLock = document.exitPointerLock ||
			   document.mozExitPointerLock ||
			   document.webkitExitPointerLock;
                           document.exitPointerLock();
                    }
                }, false);
            } 
            else{
                anleitung.innerHTML = 'Bist du uncool. <br>Your browser doesn\'t seem to support Pointer Lock API<br>Einfach in Firefox öffnen';
            }
            
            
           

            var prevTime = performance.now();
            var velocity = new THREE.Vector3();
            
            var walksound = new Audio('sounds/walk.mp3');
            

            checkKeys();
            animate();
            
            function checkKeys(event){
            // Key-Numbers: http://help.adobe.com/en_US/AS2LCR/Flash_10.0/help.html?content=00000520.html
                var onKeyDown = function(event){
               
                    // up oder w
                    if(event.keyCode === 38 || event.keyCode === 87) {
                        if (checkCollision(rayFMU, rayFLU, rayFRU, rayFMD, rayFLD, rayFRD)) {
							moveForward = false;
						}
						else {
							moveForward = true;
							walksound.play();
						}
                    }
                    // left oder a
                    if(event.keyCode === 37 || event.keyCode === 65) {
						if (checkCollision(rayLMU, rayLFU, rayLBU, rayLMD, rayLFD, rayLBD)) {
							moveLeft = false;
						}
						else {
							moveLeft = true;
							walksound.play();
						}
                    }
					
                    // down oder s
                    if(event.keyCode === 40 || event.keyCode === 83) {
						if (checkCollision(rayBMU, rayBLU, rayBRU, rayBMD, rayBLD, rayBRD)) {
							moveBackward = false;
						}
						else {
							moveBackward = true;
							walksound.play();
						}
                    }
                    // right oder d
                    if(event.keyCode === 39 || event.keyCode === 68) {
						if (checkCollision(rayRMU, rayRFU, rayRBU, rayRMD, rayRFD, rayRBD)) {
							moveRight = false;
						}
						else {
							moveRight = true;
							walksound.play();
						}
                    }
                    
					// strg (debug)
                    if(event.keyCode === 17) {
						alert(yawObject.position.x + ", " + yawObject.position.y + ", " + yawObject.position.z + "\n" + dirFront.x + ", " + dirFront.y + ", " + dirFront.z);
                    }
                };

                var onKeyUp = function(event){
                    // up oder w
                    if(event.keyCode === 38 || event.keyCode === 87) {
                        moveForward = false;
                        walksound.pause();
                    }
                    // left oder a
                    if(event.keyCode === 37 || event.keyCode === 65) {
                        moveLeft = false; 
                        walksound.pause();
                    }
                    // down oder s
                    if(event.keyCode === 40 || event.keyCode === 83) {
                        moveBackward = false;
                        walksound.pause();
                    }
                    // right oder d
                    if(event.keyCode === 39 || event.keyCode === 68) {
                        moveRight = false;
                        walksound.pause();
                    }
                };

            document.addEventListener('keydown', onKeyDown, false);
            document.addEventListener('keyup', onKeyUp, false); 
        }
        
        
        function animate(){
            requestAnimationFrame(animate);
            
            if(controlsEnabled){		
                var time = performance.now();
                var delta = (time - prevTime) / 1000;
                
                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                if(moveForward) velocity.z -= 25.0 * delta;
                if(moveBackward) velocity.z += 25.0 * delta;

                if(moveLeft) velocity.x -= 25.0 * delta;
                if(moveRight) velocity.x += 25.0 * delta;


                controls.getObject().translateX( velocity.x * delta );
                controls.getObject().translateZ( velocity.z * delta );
                prevTime = time;

			}

			render();
        }
        </script>
        
        
        <!-- AUDIO -->
        <script>
            function setVolume()
            {
                sound1 = document.getElementById("standardbackgroundmusic");
                sound1.volume = 0.1;
                
                sound2 = document.getElementById("rainmusic");
                sound2.volume = 0.2;
                
                sound3 = document.getElementById("walksound");
                sound3.volume = 1.0;
            }
            
            window.onload = setVolume;
        </script>
        
        
        
       
        <!-- STANDARD AUDIO BACKGROUND -->
        <audio autoplay loop id="standardbackgroundmusic">
                <source src="sounds/scarynight.ogg">
                <source src="sounds/scarynight.mp3">
        </audio>
        
        <!-- RAIN AUDIO BACKGROUND -->
        <audio autoplay loop id="rainmusic">
               <source src="sounds/rain.ogg">
                <source src="sounds/rain.mp3">
        </audio>
        
        <!-- Walking Sound -->
        <audio loop id="walksound">
            <source src="sounds/walk.mp3">
            <source src="sounds/walk.ogg">
        </audio>
        
        
    </body>
</html>
